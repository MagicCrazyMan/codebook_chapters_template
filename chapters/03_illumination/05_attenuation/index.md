现实世界中，光照的强度并不是恒定的，光源射出的光线的能量会随着传播的距离增长而衰减。在计算机图形学中一般使用平方反比距离衰减因子模拟光衰效果，且为了更灵活地模拟柔和光照，同时引入了多项式公式及对应的系数。

此外，除了衰减函数外，光衰还需要引入另外一个物理属性：**光源发光强度**。在距离不变的情况下，光源发光强度越大，最终物体表面接受到的光照强度越强。为了增加灵活性，实际应用中可以直接将为三原色三个不同的分量单独设置不同的发光强度（本例中没有编写单独设置发光强度分量的功能）。

$$
E = \dfrac{I}{a + bd + cd^2}
$$

其中 $E$ 为物体表面接受的光照强度；$I$ 为光源发光强度；$d$ 为光源到物体的距离（米）；$a$, $b$ 和 $c$ 为多项式中每项的衰减系数。

引入光衰函数之后，漫反射和镜面放射就可以引入光衰并转化成下面的计算公式（环境光反射根据其定义可知，其不应该受到光衰的影响）：

$$
E_d = \dfrac{I_d L_d}{a + bd + cd^2} k_d \max((\vec{l} \cdot \vec{n}), 0)
$$
$$
E_s = \dfrac{I_s L_s}{a + bd + cd^2} k_s \max((\vec{v} \cdot \vec{r})^{\alpha}, 0)
$$

将环境光反射、漫反射、镜面反射以及光衰全部融合到一起后，便可得到混合光照函数：

$$
E = \dfrac{1}{a + bd + cd^2} (I_d k_d L_d \max((\vec{l} \cdot \vec{n}), 0) + I_s k_s L_s \max((\vec{v} \cdot \vec{r})^{\alpha}, 0)) + I_a k_a L_a
$$

如果我们将发光强度直接混合进光照颜色中（也即认为光照颜色中三原色每个分量的取值范围可以超过 $1$），那我们就可以得到简单一点的公式：

$$
E = \dfrac{1}{a + bd + cd^2} (k_d L_d \max((\vec{l} \cdot \vec{n}), 0) + k_s L_s \max((\vec{v} \cdot \vec{r})^{\alpha}, 0)) + k_a L_a
$$

_实际应用中需要额外注意，当光衰因子的分母为 0 时，公式是无效的，注意边界处理。_

> 在实际应用中，光衰并不仅仅发生于光源到物体之间，同时也发生在物体到摄像机之间，所以最终上光衰距离（不考虑物体表面吸收的能量）是光线从光源到物体的距离和从物体到摄像机之间距离的和。

> 为了更好地展示光衰的变化效果，该章节会使用 [Phong Shading](./20_shading/02_phongshading) 渲染光照。

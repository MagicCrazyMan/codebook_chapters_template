本章介绍如何实现一个矩形限制范围的光源。和聚光灯类似，我们也需要一个特定的限制的范围来控制光线是否可见，最好是也可以做到平滑光照。但相对于聚光灯的圆形范围而言，矩形范围的计算更加复杂，毕竟其不能像聚光灯圆形范围那样直接计算夹角就可以知道是否在光照范围内。本章介绍一种利用几何变换实现矩形范围光照的思路。

在开始之前，我们需要考虑如何运用矩形范围，我们可以发现，像聚光灯那样仅用夹角是不足以判断矩形的。此处我们可以将思维从怎么在场景中判断矩形限制范围，换另一种思路：我们找出矩形面与光线的交点，然后把交点和矩形面移动到一个可以方便我们判断交点是否在矩形范围内的地方上。这就是本章渲染的核心流程，下面我们详细介绍怎么实现。

首先我们要创建光源，和聚光灯类似，我们为矩形光源指定一个光源位置、一个光照方向。但为了便于计算，我们不像前面创建光源那样直接指定光源的世界坐标，而是直接将光源位置指定到原点（`vec3(0.0, 0.0, 0.0)`），光照方向指定为朝向 Z 轴正方向（`vec3(0.0, 0.0, 1.0)`），后面使用的时候我们会通过模型矩阵将光源移动到世界坐标上。（光照方向需要使用法向量矩阵变换）

> 位置和方向可以根据实际需要设置，只要模型矩阵是能正确将光源移动到我们需要的位置即可。

随后我们考虑如何创建矩形限制范围，此处我们采样直接定义矩形的范围的宽度（`width`）和长度（`height`），为了方便计算，我们将矩形的圆心设置为原点，光照方向作为矩形的法线，此时我们就可以获得一个在 XY 平面上的矩形，其两个对角的坐标为 `[-width / 2, -height / 2]` 和 `[width / 2, height / 2]`。但在现实中，一般矩形发光面并不会和光照位置重合，所以我们需要将矩形朝外移动一定距离，由此可以得到矩形中心的位置坐标为（`vec3(0.0, 0.0, distance)`）。矩形平面的中心也会经过模型矩阵移动到世界坐标上。

> 代码中矩形中心的坐标并不是直接指定的，而是基于 `distance` 和法线进行向量变换得到的，但是其效果和直接指定是一致的（需要注意的是，这个效果一致仅仅是在本文设置的参数的情况下一致，如果矩形的初始化参数和本文的不一致，就不一定相同。基于向量变换得到结果是一定正确的）。

构建完矩形之后，我们就考虑创建模型矩阵。模型矩阵和前面章节的创建是相同的，指定参数即可，但此处我们需要一步额外的操作：我们需要计算模型矩阵的逆矩阵 `invertModelMatrix`。我们知道模型矩阵是将点从一个位置变换到另一个位置，那逆模型矩阵的效果也很显然，它将点从另一个位置变换回原来的位置。我们需要逆模型矩阵将光线和矩形面的交点重新变换回 XY 平面上，这样我们就可以直接使用 `width` 和 `height` 判断交点是否落在矩形范围内了。

完成上述步骤之后，我们的光源就移动到世界坐标系上了，可以开始渲染流程。和聚光灯一样，我们需要光线方向向量 `lightDirection` 并计算其与矩形平面的交点。交点的计算稍微有些复杂，此处做简单介绍：

1. 计算位置点 `p` 到平面的距离 `d`，见[点到平面的距离](#点到平面的距离)
2. 计算光线方向向量（归一化）`l` 与矩形平面法向量（归一化）`n` 的夹角余弦值 `cosineAngle = dot(l, n)`
3. 使用 `d` 除以 `cosineAngle` 得到位置点沿着光线方向到矩形平面的距离 `h = d / cosineAngle`
4. 将 `l` 乘以 `h` 得到位置点移动到矩形平面需要偏移的向量值 `forward = l * h`
5. 基于坐标点 `p` 移动需要偏移的向量值即可得到光线方向与矩形平面的交点 `intersection = p + forward`

得到交点 `intersection` 后，使用逆模型矩阵 `invertModelMatrix` 将交点变换回 XY 平面上，然后我们判断交点的 `x` 和 `y` 轴坐标值是否超出矩形上下左右边界（`[-width / 2, -height / 2, width / 2, height / 2]`）即可。若要获得平滑采样步进，可以和聚光灯效果一样，使用 `smoothstep` 进行平滑采样，对于矩形来说可以分成 `x` 和 `y` 轴两个独立的采样，然后使用两者中较小的一个作为最终的采样值。

> 除此之外，代码实现中还做了一些额外的优化判断：
> - 如果矩形面积为 0（长度或宽度为 0），直接认为无灯光
> - 如果位置点在光源照射范围后方（光线方向向量与光源照射方向夹角余弦值为负数），直接认为无灯光
> - 如果位置点在光照照射范围前方，但处于矩形平面后方（光线方向向量与矩形中心到位置点的方向向量夹角余弦值为负数），直接认为无灯光。这条判断可以根据实际场景确实是否使用，毕竟按照道理来说矩形平面只是一个虚构的用于计算的平面，现实中只要能被光源照射到的位置就应该有光照效果。

实际上，这个方案是一种通用共面多边形限制范围光源的实现方案。对于任何共面多边形，我们都可以计算光线方向和平面的交点，然后将交点变换回 XY 平面中，在 XY 平面上使用多边形相交算法判断点是否与多边形相交，最后输出结果。但多边形相交算法的计算量对于 GPU 而言确实是非常沉重的，所以一般不会去实现这种特殊的灯光效果。

## 点到平面的距离

设存在一平面，已知其法向量为 $\vec{N} (A, B, C)$，同时已知平面上任意一点坐标 $Q(x_0, y_0, z_0)$。对于任意点 $P(x_1, y_1, z_1)$，其到平面的距离为：
  
$$
d = |\vec{n} \cdot \vec{v}|
$$

其中，

$\vec{n}$ 为归一化平面法向量：$\vec{n} = \dfrac{\vec{N}}{|\vec{N}|} = \dfrac{(A, B, C)}{\sqrt{A^2 + B^2 + C^2}}$

$\vec{v}$ 为点 $P$ 指向点 $Q$ 的向量（不要归一化）：$\vec{v} = P - Q = (x_1 - x_0, y_1 - y_0, z_1 - z_0)$

将方程代入，即可得点到平面距离公式：

$$
d = \dfrac{|A(x_1 - x_0) + B(y_1 - y_0) + C(z_1 - z_0)|}{\sqrt{A^2 + B^2 + C^2}}
$$

此外，考虑到平面方程 $A(x - x_0) + B(y - y_0) + C(z - z_0) = 0$，若改成成标准方程 $Ax + By + Cz + D = 0$，可得 $D = -Ax_0 - By_0 - Cz_0$。将 $D$ 代入上述公式，可得另一点到平面公式：

$$
d = \dfrac{|Ax_1 + By_1 + Cz_1 + D|}{\sqrt{A^2 + B^2 + C^2}}
$$

如果我们已知平面方程的标准式的 $A$ $B$ $C$ $D$ 系数，则可以直接使用上公式。
